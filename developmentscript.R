setwd("C:/Users/Rotterdam.LAP13971/Desktop/EDA")

writecode <- function(dataframe, directory=getwd(), showcode=TRUE, keepdataframe=FALSE) {
  library(knitr)
  library(ggplot2)
  library(kableExtra)
  setwd(directory)
  inputdata <- dataframe
  save(inputdata, file="./df.rda")
  columns <- names(dataframe)
  classes <- sapply(dataframe, class)
  nameofdf <- deparse(substitute(dataframe))
  n <- "\n"
  sink(file="EDA.Rmd")
  cat("---", n)
  cat("title: ", '"Exploratory data analysis of ', nameofdf, '"', n, sep="")
  cat("author: ",  '"script written by Jorik Schra"', n, sep="")
  cat(paste0("date: ", '"', format(Sys.time(), format="%d %B %Y")), '"', n, sep="")
  cat("output: ", n)
  cat("  ", "html_document:",n)
  cat("    ", "toc: true", n)
  cat("    ", "toc_float: true", n)
  cat("---", n)
  cat(n)
  cat("```{r setup, include=FALSE}", n)
  cat("knitr::opts_chunk$set(echo = ", showcode, ", warning=FALSE)", n)
  cat("```", n)
  cat(n)
  cat("```{r}", n)
  cat("# Packages", n)
  cat("library(ggplot2)", n)
  cat(n)
  cat("# Data", n)
  cat('load("./df.rda")', n)
  cat(n)
  cat("# Palette for plots", n)
  cat('rgb.palette <- colorRampPalette(c("navy", "royalblue", "deepskyblue1", 
                                  "lawngreen", "chartreuse2", "forestgreen"))', n)
  cat(n)
  cat("# Functions", n)
  cat("## Print function for tables", n)
  cat('print_table <- function(dataframe, caption="Don`t forget your caption", font=12.5) {', n)
  cat("kable(dataframe,", n)
  cat("      ", 'format="html",', n)
  cat("      ", 'align=c("l", rep("c", ncol(dataframe)-1)),', n)
  cat("      ", "caption=caption) %>%", n)
  cat("  ", 'kable_styling(bootstrap_options = c("striped", "hover", "responsive"),', n)
  cat("                ", "full_width=FALSE,", n)
  cat("                ", "font_size=font)", n)
  cat("}", n)
  cat("```", n)
  cat(n)
  cat("## Missing values", n)
  cat("```{r}", n)
  cat("# Create an ordered data frame with missing value percentages per feature", n)
  cat("missing <- sapply(inputdata, function(x) sum(is.na(x))/nrow(inputdata))", n)
  cat('missing <- data.frame("Feature"=names(missing),', n)
  cat("                     ", '"Missing percentage"=missing,', n)
  cat("                     ", "check.names=FALSE)", n)
  cat("missing <- missing[order(missing$`Missing percentage`, decreasing=TRUE),]", n)
  cat("row.names(missing) <- c()", n)
  cat("```", n)
  cat(n)
  if (length(columns)<=60) {
    cat("```{r, fig.height=", ifelse(length(columns)<=30, 5, 10), "}", n, sep="")
    cat("# Plot the missing value percentages (only executed with data containing 60 or less features)", n)
    cat("ggplot(data=missing, aes(x=reorder(Feature, -`Missing percentage`), y=`Missing percentage`)) +", n)
    cat("  ", 'geom_bar(stat="identity", aes(fill=`Missing percentage`)) +', n)
    cat("  ", "coord_flip() +", n)
    cat("  ", "theme_bw() +", n)
    cat("  ", 'labs(x="Features", title="Percentage of missing values per feature") +', n)
    cat("  ", 'scale_y_continuous(breaks=seq(0, 1, .10), labels=paste0(seq(0, 100, 10), "%"), limits=c(0,1.05), expand=c(0,0)) + ', n)
    cat("  ", "theme(plot.title = element_text(hjust = 0.5)) +", n)
    cat("  ", "guides(fill=FALSE) +", n)
    cat("  ", "expand_limits(y=0)", n)
    cat("```", n, sep="")
    cat(n)
  } else {
    cat("```{r}", n)
    cat("# Print the missing value percentages per feature (only executed with data containing more than 60 features)", n)
    cat("# Features that do not have missing values are removed", n)
    cat("missing <- missing[missing$`Missing percentage`>0,]", n)
    cat('print_table(missing, caption="Percentage of missing values per feature", font=10)', n)
    cat("```", n)
  }
  cat("## Exploratory Data Analysis {.tabset .tabset-fade}", n, sep="")
  for (i in 1:ncol(dataframe)) {
    if (classes[i] %in% c("numeric", "integer")) {
        if (length(unique(inputdata[,i]))>40) {
          cat("### ", columns[i], n, sep="")
          cat("```{r}", n, sep="")
          cat("ggplot(data=inputdata, ", "aes(x=", columns[i],")) +", n, sep="")
          cat("geom_histogram(bins=40, fill=rgb.palette(40)) +", n, sep="")
          cat('labs(y="Count", title="Histogram of ', columns[i], '", x="") +', n, sep="")
          cat("theme(plot.title = element_text(hjust = 0.5))", n)
          cat("```", n)
          cat(n)
        }
        else {
          cat("### ", columns[i], n, sep="")
          cat("```{r}", n, sep="")
          cat("bins <- length(unique(inputdata$", columns[i], "))", n, sep="")
          cat("ggplot(data=inputdata, ", "aes(x=", columns[i],")) +", n, sep="")
          cat("geom_histogram(bins=bins, fill=rgb.palette(bins)) +", n, sep="")
          cat('labs(y="Count", title="Histogram of ', columns[i], '", x="") +', n, sep="")
          cat("theme(plot.title = element_text(hjust = 0.5))", n)
          cat("```", n)
          cat(n)   
        }
    }
  }
  sink()
  rmarkdown::render(input="./EDA.Rmd", output_format="html_document", clean=FALSE)
  browseURL(paste('file://', directory, 'EDA.html', sep='/'))
  if (!keepdataframe) {
    invisible(file.remove("./df.rda"))
  }
}

